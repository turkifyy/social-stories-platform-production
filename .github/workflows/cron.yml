name: Stories Scheduler Cron

on:
  schedule:
    - cron: '*/5 * * * *' # Every 5 minutes
  workflow_dispatch: # Allows manual trigger

jobs:
  cron:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        attempt: [1, 2, 3] # Smart retry strategy
    steps:
      - name: Wait for jitter
        run: sleep $((RANDOM % 20)) # Reduced jitter for faster execution
      
      - name: Health Check System
        run: |
          echo "üîç Checking system health before trigger..."
          curl -s -I "${{ secrets.APP_URL }}/api/firebase-config" | grep -q "200 OK" || (echo "‚ùå System offline" && exit 1)
      
      - name: Trigger Social Stories Cron
        id: trigger
        run: |
          echo "üöÄ Triggering Stories Scheduler..."
          RESPONSE=$(curl -s -D - -o response_body.json -X POST "${{ secrets.APP_URL }}/api/admin/cron/trigger" \
          -H "Authorization: Bearer ${{ secrets.CRON_SECRET_KEY }}" \
          -H "Content-Type: application/json")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep HTTP | tail -n 1 | awk '{print $2}')
          echo "üì° HTTP Response Code: $HTTP_CODE"
          cat response_body.json
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "‚ùå API Trigger failed with code $HTTP_CODE"
            exit 1
          fi
          echo "‚úÖ API Trigger successful"
